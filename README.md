# Mattermost.ChatOps.Bot

## Общее описание
Бот предназначен для выполнения команд, полученных через Mattermost

Прослушивание сообщений осуществляется через WebSocket.
Сообщения, подлежащие обработке, должны содержать тэг бота (задается в `utils/incoming_post_handler.py`).

Бот отвечает на сообщение, либо создавая дочерний тред, либо (если его вызвали из треда), продолжая существующий.
Бот не умеет в интерактивные диалоги с кнопочками, и т.д. Он не накапливает контекст, т.е. работает по системе "один запрос - один ответ".

Доступ к боту ограничен пользователями, указанными в конфиге.

## Конфигурация

### Пример
```json
{
    "mattermost_allowed_users": [
        {
            "id": "1f84d516a1494c1b9057f89fb2eab2d0",
            "name": "ivanovii",
            "kaiten_id": 123
        },
        {
            "id": "287422ffa5984bfd8fc720c0e1960fef",
            "name": "petrovapp",
            "kaiten_id": 456
        },
    ],
    "mattermost": {
        "host": "mattermost.mycompany.com",
        "token": "4256f55502e64dd59471e424653b1d4d"
    },
    "kaiten": {
        "host": "kaiten.mycompany.com",
        "token": "e90c03b3-cddb-4053-a7ba-201b0e581e08"
    }
}
```

### Секция mattermost_allowed_users
Содержит массив данных о пользователях, сообщения от которых будет слушать бот

#### id - ИД пользователя в Mattermost
Можно получить запросом к API Mattermost:
```shell
curl --location --request POST 'https://mattermost.mycompany.com/api/v4/users/search' \
--header 'Authorization: Bearer *****' \
--header 'Content-Type: application/json' \
--data-raw '{
    "term": "@ivanovii"
}' 
```
https://api.mattermost.com/

#### name - имя пользователя в Mattermost
Это логин пользователя, например `ivanovii`. Соответствует тэгу без собачки

#### kaiten_id - числовой ИД пользователя в Kaiten
Можно получить, например, из пользователей пространства в Кайтен:
```shell
curl --location --request GET 'kaiten.mycompany.com/api/v1/spaces/111/users' \
--header 'Authorization: Bearer *****'
```
https://developers.kaiten.ru/

### Секция mattermost
Содержит свойства для подключения к Mattermost через API и WebSocket:
* Имя хоста
* Токен бот-аккаунта

### Секция kaiten
Содержит свойства для подключения к API Kaiten:
* Имя хоста
* Токен учетной записи, под которой работаем в Кайтен

## Поддерживаемые команды

### Помощь
Любая необработанная фраза - выводится помощь с образцами команд

### Создание задач в Кайтен
Бот умеет создавать задачку в Кайтен. По умолчанию, задачи создаются на доске бэклога, на указанной дорожке.
Если в тексте присутствует слово `"тех*долг"` - задача создастся на доске Технической долг, на указанной дорожке.
Идентификаторы досок, дорожек и типов задач задаются в `utils/kaiten_helper.py`:
 * Для обычных задач 
 ```python
    # Параметры по умолчанию
    board_id = 1  # ИД Доски
    lane_id = 2  # ИД Дорожки на Доске
    type_id = 26  # ИД типа карточки
    properties = {}
 ```
 * Для техдолговых задач
 ```python
    # Параметры для задач Технического долга
    board_id = 4  # Доска: Технический долг
    lane_id = 2  # Дорожка: Важные
    type_id = 7  # Тип для технического долга
 ```

Чтобы точно задать заголовок задачи, можно использовать `'ординарные'`, либо `"двойные"` кавычки

Создатель задачи в Кайтен - сотрудник, написавший боту сообщение. Маппинг пользователей Mattermost на пользователей Кайтена задан в конфиге

Примеры запросов:
* @bot Создай задачу \"Сделать бизнесу фичу\"
* @bot Заведи таску в техдолге 'Обновить все фреймворки на последнюю версию'
* @bot Новая задачка Распознавание печатей на документах
